# WAF Rules for Multi-Tenant API
# These rules should be applied to the AWS WAF associated with the ALB

# Rate Limiting Rules
- Name: "APIRateLimit"
  Priority: 100
  Statement:
    RateBasedStatement:
      Limit: 1000
      AggregateKeyType: IP
      ScopeDownStatement:
        ByteMatchStatement:
          FieldToMatch:
            UriPath: {}
          PositionalConstraint: PREFIX
          SearchString: /api/
  Action:
    Block: {}
  VisibilityConfig:
    SampledRequestsEnabled: true
    CloudWatchMetricsEnabled: true
    MetricName: "APIRateLimit"

# SQL Injection Prevention
- Name: "SQLInjectionPrevention"
  Priority: 200
  Statement:
    SqlInjectionMatchStatement:
      FieldToMatch:
        AllQueryArguments: {}
      TextTransformations:
        - Priority: 0
          Type: URL_DECODE
        - Priority: 1
          Type: LOWERcase
  Action:
    Block: {}
  VisibilityConfig:
    SampledRequestsEnabled: true
    CloudWatchMetricsEnabled: true
    MetricName: "SQLInjectionPrevention"

# Cross-Site Scripting Prevention
- Name: "XSSPrevention"
  Priority: 300
  Statement:
    XssMatchStatement:
      FieldToMatch:
        AllQueryArguments: {}
      TextTransformations:
        - Priority: 0
          Type: URL_DECODE
        - Priority: 1
          Type: HTML_ENTITY_DECODE
  Action:
    Block: {}
  VisibilityConfig:
    SampledRequestsEnabled: true
    CloudWatchMetricsEnabled: true
    MetricName: "XSSPrevention"

# Common Exploits Prevention
- Name: "CommonExploits"
  Priority: 400
  Statement:
    ManagedRuleGroupStatement:
      VendorName: AWS
      Name: AWSManagedRulesCommonRuleSet
      ExcludedRules: []
  OverrideAction:
    None: {}
  VisibilityConfig:
    SampledRequestsEnabled: true
    CloudWatchMetricsEnabled: true
    MetricName: "CommonExploits"

# Anonymous IP Blocking
- Name: "AnonymousIPBlock"
  Priority: 500
  Statement:
    ManagedRuleGroupStatement:
      VendorName: AWS
      Name: AWSManagedRulesAnonymousIpList
      ExcludedRules: []
  OverrideAction:
    None: {}
  VisibilityConfig:
    SampledRequestsEnabled: true
    CloudWatchMetricsEnabled: true
    MetricName: "AnonymousIPBlock"

# Known Bad Inputs
- Name: "KnownBadInputs"
  Priority: 600
  Statement:
    ManagedRuleGroupStatement:
      VendorName: AWS
      Name: AWSManagedRulesKnownBadInputsRuleSet
      ExcludedRules: []
  OverrideAction:
    None: {}
  VisibilityConfig:
    SampledRequestsEnabled: true
    CloudWatchMetricsEnabled: true
    MetricName: "KnownBadInputs"

# PHP Injection Prevention (for completeness)
- Name: "PHPIjection"
  Priority: 700
  Statement:
    SizeConstraintStatement:
      FieldToMatch:
        QueryString: {}
      ComparisonOperator: GT
      Size: 1024
      TextTransformations:
        - Priority: 0
          Type: NONE
  Action:
    Block: {}
  VisibilityConfig:
    SampledRequestsEnabled: true
    CloudWatchMetricsEnabled: true
    MetricName: "PHPIjection"

# Additional API-specific rules
- Name: "APIPathValidation"
  Priority: 800
  Statement:
    NotStatement:
      Statement:
        ByteMatchStatement:
          FieldToMatch:
            UriPath: {}
          PositionalConstraint: PREFIX
          SearchString: /api/
          TextTransformations:
            - Priority: 0
              Type: COMPRESS_WHITE_SPACE
  Action:
    Allow: {}
  VisibilityConfig:
    SampledRequestsEnabled: true
    CloudWatchMetricsEnabled: true
    MetricName: "APIPathValidation"