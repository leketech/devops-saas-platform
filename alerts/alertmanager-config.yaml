apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: platform
data:
  alertmanager.yml: |
    global:
      smtp_smarthost: 'localhost:587'
      smtp_from: 'alertmanager@multitenant-api.local'
      smtp_auth_username: 'alertmanager'
      smtp_auth_password: 'secret'

    route:
      group_by: ['alertname', 'severity', 'category']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
      receiver: 'default-webhook'
      routes:
        - matchers:
            - severity = "critical"
          receiver: 'critical-webhook'
          group_wait: 10s
          repeat_interval: 1h
        - matchers:
            - severity = "warning"
          receiver: 'warning-webhook'
          group_wait: 30s
          repeat_interval: 3h

    receivers:
      - name: 'default-webhook'
        webhook_configs:
          - url: 'http://webhook-receiver.platform.svc.cluster.local:8080/webhook'
            send_resolved: true
      - name: 'critical-webhook'
        webhook_configs:
          - url: 'http://webhook-receiver.platform.svc.cluster.local:8080/webhook/critical'
            send_resolved: true
      - name: 'warning-webhook'
        webhook_configs:
          - url: 'http://webhook-receiver.platform.svc.cluster.local:8080/webhook/warning'
            send_resolved: true
      - name: 'email'
        email_configs:
          - to: 'admin@multitenant-api.local'
            send_resolved: true