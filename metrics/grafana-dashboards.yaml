apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: platform
data:
  multitenant-api-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Multi-Tenant API Dashboard",
        "tags": ["api", "multi-tenant", "red"],
        "style": "dark",
        "timezone": "browser",
        "refresh": "5s",
        "panels": [
          {
            "id": 1,
            "title": "Request Rate",
            "type": "graph",
            "gridPos": {"h": 8, "w": 8, "x": 0, "y": 0},
            "targets": [
              {
                "expr": "sum(rate(http_requests_total{app=\"multitenant-api\"}[1m]))",
                "legendFormat": "Total Requests/sec"
              }
            ],
            "yAxes": [
              {
                "label": "Requests/sec"
              }
            ]
          },
          {
            "id": 2,
            "title": "Request Duration (95th percentile)",
            "type": "graph",
            "gridPos": {"h": 8, "w": 8, "x": 8, "y": 0},
            "targets": [
              {
                "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{app=\"multitenant-api\"}[1m])) by (le))",
                "legendFormat": "P95 Duration"
              }
            ],
            "yAxes": [
              {
                "label": "Duration (s)"
              }
            ]
          },
          {
            "id": 3,
            "title": "Error Rate",
            "type": "graph",
            "gridPos": {"h": 8, "w": 8, "x": 16, "y": 0},
            "targets": [
              {
                "expr": "sum(rate(http_requests_errors_total{app=\"multitenant-api\"}[1m])) / sum(rate(http_requests_total{app=\"multitenant-api\"}[1m])) * 100",
                "legendFormat": "Error Rate %"
              }
            ],
            "yAxes": [
              {
                "label": "Error Rate (%)"
              }
            ]
          },
          {
            "id": 4,
            "title": "Active Requests",
            "type": "graph",
            "gridPos": {"h": 8, "w": 8, "x": 0, "y": 8},
            "targets": [
              {
                "expr": "http_active_requests{app=\"multitenant-api\"}",
                "legendFormat": "Active Requests"
              }
            ],
            "yAxes": [
              {
                "label": "Requests"
              }
            ]
          },
          {
            "id": 5,
            "title": "API Requests by Tenant",
            "type": "graph",
            "gridPos": {"h": 8, "w": 8, "x": 8, "y": 8},
            "targets": [
              {
                "expr": "sum by (tenant_id) (rate(http_requests_total{app=\"multitenant-api\"}[1m]))",
                "legendFormat": "{{tenant_id}}"
              }
            ],
            "yAxes": [
              {
                "label": "Requests/sec"
              }
            ]
          },
          {
            "id": 6,
            "title": "Pod Count",
            "type": "graph",
            "gridPos": {"h": 8, "w": 8, "x": 16, "y": 8},
            "targets": [
              {
                "expr": "kube_deployment_status_replicas{deployment=\"multitenant-api\", namespace=\"platform\"}",
                "legendFormat": "Desired"
              },
              {
                "expr": "kube_deployment_status_replicas_available{deployment=\"multitenant-api\", namespace=\"platform\"}",
                "legendFormat": "Available"
              }
            ],
            "yAxes": [
              {
                "label": "Pods"
              }
            ]
          }
        ],
        "time": {"from": "now-15m", "to": "now"},
        "timepicker": {
          "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "1d"]
        }
      },
      "folder": "",
      "overwrite": true
    }