# Spot Instances Configuration for EKS
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-autoscaler-config
  namespace: kube-system
data:
  expander: least-waste
  balance-similar-node-groups: true
  scale-down-enabled: true
  scale-down-delay-after-add: 10m
  scale-down-unneeded-time: 10m
  scale-down-utilization-threshold: 0.7
  skip-nodes-with-local-storage: false
  skip-nodes-with-system-pods: false
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: spot-interruption-handler
  namespace: kube-system
  labels:
    app: spot-interruption-handler
spec:
  selector:
    matchLabels:
      app: spot-interruption-handler
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: spot-interruption-handler
    spec:
      hostNetwork: true
      hostPID: true
      nodeSelector:
        lifecycle: Ec2Spot
      tolerations:
      - key: "lifecycle"
        operator: "Equal"
        value: "Ec2Spot"
        effect: "NoSchedule"
      containers:
      - name: spot-handler
        image: amazonlinux:2
        command:
        - sh
        - -c
        - |
          #!/bin/bash
          # Check for spot interruption notice
          while true; do
            if curl -f http://169.254.169.254/latest/meta-data/spot/instance-action; then
              echo "Spot interruption notice received, draining node..."
              kubectl cordon $(hostname)
              kubectl drain $(hostname) --ignore-daemonsets --delete-local-data --timeout=60s
            fi
            sleep 5
          done
        securityContext:
          privileged: true
        env:
        - name: HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: KUBECTL
          value: "/usr/bin/kubectl"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: spot-interruption-handler
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: spot-interruption-handler
rules:
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["get", "patch"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["list", "delete", "get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: spot-interruption-handler
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: spot-interruption-handler
subjects:
- kind: ServiceAccount
  name: spot-interruption-handler
  namespace: kube-system