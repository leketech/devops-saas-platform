# Budget Alerts Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: budget-alerts-config
  namespace: platform
data:
  # Configuration for budget monitoring
  budget-config.json: |
    {
      "budgets": [
        {
          "name": "platform-monthly-budget",
          "amount": 5000.00,
          "unit": "USD",
          "timeUnit": "MONTHLY",
          "alerts": [
            {
              "threshold": 80,
              "type": "FORECASTED",
              "recipients": ["finance@company.com", "engineering@company.com"]
            },
            {
              "threshold": 90,
              "type": "FORECASTED",
              "recipients": ["finance@company.com", "engineering@company.com"]
            },
            {
              "threshold": 100,
              "type": "ACTUAL",
              "recipients": ["finance@company.com", "engineering@company.com"]
            }
          ]
        }
      ]
    }
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: budget-monitoring-cron
  namespace: platform
spec:
  schedule: "0 9 * * *"  # Run daily at 9 AM
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: budget-monitor
          containers:
          - name: budget-monitor
            image: public.ecr.aws/aws-cli/aws-cli:latest
            command:
            - /bin/sh
            - -c
            - |
              #!/bin/bash
              # Check current spending against budget
              echo "Checking budget usage..."
              
              # Get current month-to-date spending
              current_spend=$(aws ce get-cost-and-usage \
                --time-period Start=$(date -d "1 day ago" +%Y-%m-01),End=$(date -d "now" +%Y-%m-%d) \
                --metrics "UNBLENDEDCOST" \
                --filter '{"Tags":{"Key":"Application","Values":["multitenant-api"]}}' \
                --query 'ResultsByTime[0].Total.UnblendedCost.Amount' \
                --output text)
              
              # Get budget limit
              budget_limit=5000.00
              
              # Calculate percentage
              percentage=$(echo "$current_spend * 100 / $budget_limit" | bc -l)
              
              echo "Current spend: $$current_spend"
              echo "Budget limit: $$budget_limit"
              echo "Percentage: $$percentage%"
              
              # Check if we're approaching budget
              if (( $(echo "$percentage > 80" | bc -l) )); then
                echo "WARNING: Budget usage is at $$percentage%"
                # Send notification
                curl -X POST \
                  -H "Content-Type: application/json" \
                  -d "{\"alert\": \"Budget usage at $$percentage%\", \"current_spend\": \"$$current_spend\", \"budget_limit\": \"$$budget_limit\"}" \
                  http://notification-service.platform.svc.cluster.local/alert
              fi
              
              if (( $(echo "$percentage > 90" | bc -l) )); then
                echo "CRITICAL: Budget usage is at $$percentage%"
                # Send critical notification
                curl -X POST \
                  -H "Content-Type: application/json" \
                  -d "{\"alert\": \"CRITICAL: Budget usage at $$percentage%\", \"current_spend\": \"$$current_spend\", \"budget_limit\": \"$$budget_limit\"}" \
                  http://notification-service.platform.svc.cluster.local/alert
              fi
          restartPolicy: OnFailure
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: budget-monitor
  namespace: platform
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: budget-monitor-role
  namespace: platform
rules:
- apiGroups: [""]
  resources: ["configmaps", "secrets"]
  verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: budget-monitor-rolebinding
  namespace: platform
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: budget-monitor-role
subjects:
- kind: ServiceAccount
  name: budget-monitor
  namespace: platform